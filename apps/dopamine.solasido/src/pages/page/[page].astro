---
import Layout from '../../layouts/Layout.astro'
import PostList from '../../components/PostList.astro'
import { fetchPublishedPosts } from '../../lib/data'
import { PAGE_SIZE, buildPagination, getPageItems, getTotalPages } from '../../lib/pagination'
import { SITE_DESCRIPTION, SITE_NAME } from '../../lib/site-meta'
import { buildCollectionPageStructuredData } from '../../lib/structured-data'
import type { BlogPostWithAssets } from '../../lib/types'
import type { GetStaticPaths } from 'astro'

export const getStaticPaths = (async () => {
  const posts = await fetchPublishedPosts()
  const totalPages = getTotalPages(posts.length, PAGE_SIZE)

  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const pageNum = i + 2

    return {
      params: { page: String(pageNum) },
      props: {
        posts: getPageItems(posts, pageNum, PAGE_SIZE),
        currentPage: pageNum,
        lastPage: totalPages,
      },
    }
  })
}) satisfies GetStaticPaths

interface Props {
  posts: BlogPostWithAssets[]
  currentPage: number
  lastPage: number
}

const { posts, currentPage, lastPage } = Astro.props as Props
const page = buildPagination(currentPage, lastPage)
const pageUrl = Astro.url.href
const origin = Astro.url.origin
const basePosition = (currentPage - 1) * PAGE_SIZE
const structuredData = buildCollectionPageStructuredData({
  pageUrl,
  origin,
  posts,
  pageName: `${SITE_NAME} - Page ${currentPage}`,
  positionOffset: basePosition,
  includeBlogParent: true,
})
---

<Layout
  title={`${SITE_NAME} - Page ${currentPage}`}
  description={SITE_DESCRIPTION}
  structuredData={structuredData}
>
  <PostList posts={posts} page={page} />
</Layout>
