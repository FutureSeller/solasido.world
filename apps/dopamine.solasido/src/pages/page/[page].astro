---
import Layout from '../../layouts/Layout.astro'
import PostList from '../../components/PostList.astro'
import { fetchPublishedPosts } from '../../lib/data'
import { PAGE_SIZE, buildPagination, getPageItems, getTotalPages } from '../../lib/pagination'
import type { BlogPostWithAssets } from '../../lib/types'
import type { GetStaticPaths } from 'astro'

export const getStaticPaths = (async () => {
  const posts = await fetchPublishedPosts()
  const totalPages = getTotalPages(posts.length, PAGE_SIZE)

  return Array.from({ length: totalPages - 1 }, (_, i) => {
    const pageNum = i + 2

    return {
      params: { page: String(pageNum) },
      props: {
        posts: getPageItems(posts, pageNum, PAGE_SIZE),
        currentPage: pageNum,
        lastPage: totalPages,
      },
    }
  })
}) satisfies GetStaticPaths

interface Props {
  posts: BlogPostWithAssets[]
  currentPage: number
  lastPage: number
}

const { posts, currentPage, lastPage } = Astro.props as Props
const page = buildPagination(currentPage, lastPage)
---

<Layout
  title={`Dopamine Blog - Page ${currentPage}`}
  description="부부일상툰과 신혼생활 이야기"
>
  <PostList posts={posts} page={page} />
</Layout>
