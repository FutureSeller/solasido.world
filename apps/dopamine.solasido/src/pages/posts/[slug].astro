---
import Layout from '../../layouts/Layout.astro'
import { fetchPublishedPosts } from '../../lib/data'
import { SITE_NAME } from '../../lib/site-meta'
import { buildBlogPostingStructuredData } from '../../lib/structured-data'
import { formatKoreanDate, getHostname } from '../../lib/utils'
import sanitizeHtml from 'sanitize-html'
import { marked } from 'marked'
import type { BlogPostWithAssets } from '../../lib/types'

export async function getStaticPaths() {
  const posts = await fetchPublishedPosts()

  return posts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      prevPost: index > 0 ? posts[index - 1] : null,
      nextPost: index < posts.length - 1 ? posts[index + 1] : null,
    },
  }))
}

interface Props {
  post: BlogPostWithAssets
  prevPost: BlogPostWithAssets | null
  nextPost: BlogPostWithAssets | null
}

const { post, prevPost, nextPost } = Astro.props as Props

const markdownBody = post.assets.length > 0
  ? post.body.replace(/!\[[\s\S]*?\]\([^)]+\)/g, '').trim()
  : post.body

const renderedBody = marked.parse(markdownBody, {
  async: false,
  gfm: true,
  breaks: true,
})

// Render markdown and sanitize HTML to prevent XSS attacks
const sanitizedBody = sanitizeHtml(renderedBody, {
  allowedTags: [
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'p', 'a', 'ul', 'ol', 'li', 'blockquote',
    'strong', 'em', 'code', 'pre', 'br', 'hr',
    'table', 'thead', 'tbody', 'tr', 'th', 'td',
    'img',
  ],
  allowedAttributes: {
    'a': ['href', 'target', 'rel'],
    'img': ['src', 'alt', 'title', 'width', 'height', 'loading'],
  },
})

const pageUrl = Astro.url.href
const metaDescription = post.metaDescription || post.summary
const metaImage = post.ogImageUrl || post.assets[0]?.r2Url
const structuredData = buildBlogPostingStructuredData(post, pageUrl)
---

<Layout
  title={post.title}
  description={metaDescription}
  ogTitle={post.title}
  ogDescription={metaDescription}
  ogImage={metaImage}
  ogUrl={pageUrl}
  ogType="article"
  twitterCard="summary_large_image"
  twitterTitle={post.title}
  twitterDescription={metaDescription}
  twitterImage={metaImage}
  structuredData={structuredData}
>
  <article class="container mx-auto px-4 py-8 max-w-4xl">
    <a
      href="/"
      class="inline-flex items-center gap-2 text-sm opacity-60 hover:opacity-100 transition-opacity mb-8"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      {SITE_NAME}
    </a>

    <header class="mb-8">
      <h1 class="text-4xl font-bold mb-4">{post.title}</h1>
      <time class="text-sm opacity-60">
        {formatKoreanDate(post.publishedAt)}
      </time>
    </header>

    {/* Instagram Source Link */}
    {post.canonicalUrl && (
      <a
        href={post.canonicalUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="block group mb-8"
      >
        <div class="border border-border rounded-lg overflow-hidden hover:border-primary transition-colors">
          <div class="flex items-start gap-4 p-4">
            <div class="flex-shrink-0">
              {/* Instagram Icon */}
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                </svg>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold mb-1 group-hover:text-primary transition-colors">
                Instagram
              </div>
              <div class="text-sm opacity-60 line-clamp-2">
                {post.title} · {formatKoreanDate(post.publishedAt)}
              </div>
              <div class="text-xs opacity-40 mt-2">
                {getHostname(post.canonicalUrl)}
              </div>
            </div>
            {post.assets && post.assets.length > 0 && (
              <div class="flex-shrink-0 hidden sm:block">
                <img
                  src={post.assets[0].r2Url}
                  alt="Preview"
                  width={post.assets[0].width}
                  height={post.assets[0].height}
                  class="w-20 h-20 object-cover rounded-lg"
                />
              </div>
            )}
          </div>
        </div>
      </a>
    )}

    {post.summary && (
      <div class="bg-muted p-6 rounded-lg mb-8">
        <p class="text-lg">{post.summary}</p>
      </div>
    )}

    {post.assets && post.assets.length > 0 && (
      <div class="mb-8 w-full overflow-x-auto">
        <div class="flex w-max min-w-full gap-4 snap-x snap-mandatory pb-2">
          {post.assets.map((asset, index) => (
            <div class="snap-start shrink-0 w-[85vw] max-w-[520px] sm:w-[70vw] md:w-[52vw] lg:w-[44vw] overflow-hidden rounded-lg bg-muted">
              <img
                src={asset.r2Url}
                alt={`Image ${index + 1}`}
                width={asset.width}
                height={asset.height}
                class="block w-full h-auto"
                loading={index === 0 ? 'eager' : 'lazy'}
              />
            </div>
          ))}
        </div>
      </div>
    )}

    <div class="prose prose-lg max-w-none" set:html={sanitizedBody} />

    {/* Post Navigation */}
    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-8 border-t border-border">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {prevPost ? (
            <a
              href={`/posts/${prevPost.slug}`}
              class="group p-4 border border-border rounded-lg hover:bg-muted transition-colors"
            >
              <div class="text-xs opacity-60 mb-2">← 이전 포스트</div>
              <div class="font-semibold group-hover:text-primary transition-colors">
                {prevPost.title}
              </div>
            </a>
          ) : (
            <div></div>
          )}

          {nextPost && (
            <a
              href={`/posts/${nextPost.slug}`}
              class="group p-4 border border-border rounded-lg hover:bg-muted transition-colors text-right md:text-right"
            >
              <div class="text-xs opacity-60 mb-2">다음 포스트 →</div>
              <div class="font-semibold group-hover:text-primary transition-colors">
                {nextPost.title}
              </div>
            </a>
          )}
        </div>
      </nav>
    )}
  </article>
</Layout>
